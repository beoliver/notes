# Part 1

Clojure is a **hosted** language. This means that it runs on top of an existing platform, such as the Java Virtual Machine (JVM), Common Language Runtime (CLR), etc. This allows Clojure to leverage the capabilities, libraries, and tools of the underlying platform.

For the purposes of this text will assume that we are using the Java Virtual Machine (JVM) as the host.

Instead of installing the `clojure` tool via homebrew or similar we will look at the most basic installation possible. The idea is that by doing this, we will get a better understand of what is actually going on.

# Demystified Install

If we look at the [downloads page on the official site](https://clojure.org/releases/downloads), there is an example of "coordinates". 

```
org.clojure/clojure {:mvn/version "1.11.3"}
```

If you know a bit about Java (don't worry if you don't), then you may well have heard about Maven and the Maven repository. This is what `mvn` is a reference to. We can search there for clojure 

https://mvnrepository.com/artifact/org.clojure/clojure


At the time of writing [clojure version 1.11.3](https://mvnrepository.com/artifact/org.clojure/clojure/1.11.3) is the latest release. If you look near the top of the page you should have the option to click on the 'jar' tag. This will download the artifact.

There are two **compile dependencies**
1. [spec.alpha](https://mvnrepository.com/artifact/org.clojure/spec.alpha) - the latest version of which is [0.3.218](https://mvnrepository.com/artifact/org.clojure/spec.alpha/0.3.218). The downloaded file is called `spec.alpha-0.3.218.jar`
2. [core.specs.alpha](https://mvnrepository.com/artifact/org.clojure/core.specs.alpha) - the latest version of which is  [0.2.62](https://mvnrepository.com/artifact/org.clojure/core.specs.alpha/0.2.62). The downloaded jar is called `core.specs.alpha-0.2.62.jar`.

You can use the following bash script to download all three jars.

```bash
for item in clojure-1.11.3 spec.alpha-0.3.218 core.specs.alpha-0.2.62; do
    artifact=$(echo $item | cut -d'-' -f1)
    version=$(echo $item | cut -d'-' -f2)    
    url=$(printf "https://repo1.maven.org/maven2/org/clojure/%s/%s/%s.jar" ${artifact} "${version}" "${item}")
    curl "${url}" --output "${item}.jar"
done
```

Now that we have downloaded the jars, we can get something running. Our first instinct might be to invoke java using the `-jar` flag. However, this will result in an error:

```sh
$ java -jar clojure-1.11.3.jar
no main manifest attribute, in clojure-1.11.3.jar
```

The issue (as described on [stackoverflow](https://stackoverflow.com/questions/9689793/cant-execute-jar-file-no-main-manifest-attribute)) is that we need to set the class path and then provide a the class that contains the `main` method to run the program.

```sh
$ java -cp clojure-1.11.3.jar com.somepackage.SomeClass
```

where `-cp` is the 'classpath' flag and `com.somepackage.SomeClass` is the class that contains the `main` method to run the program.

## In search of main.

Which class contains the `main` method? We go off and find the [source](https://github.com/clojure/clojure) and use our intuition to find the file https://github.com/clojure/clojure/blob/master/src/jvm/clojure/main.java


```java
package clojure;
...
public class main { 
	...
	public static void main(String[] args) {
		...
	}
}
```

So `clojure.main` is the class that contains the `main` method! 

## JAR dependencies

Setting the class path to include `clojure-1.11.3.jar` returns the following error:

```sh
$ java -cp clojure-1.11.3.jar clojure.main
Exception in thread "main" java.lang.ExceptionInInitializerError
	at java.base/java.lang.Class.forName0(Native Method)
	at java.base/java.lang.Class.forName(Class.java:398)
	at clojure.lang.RT.classForName(RT.java:2209)
	at clojure.lang.RT.classForName(RT.java:2218)
	at clojure.lang.RT.loadClassForName(RT.java:2237)
	at clojure.lang.RT.load(RT.java:449)
	at clojure.lang.RT.load(RT.java:424)
	at clojure.core$load$fn__6908.invoke(core.clj:6161)
	at clojure.core$load.invokeStatic(core.clj:6160)
	...
```
Looking at the stack trace we notice the following line.
```
Caused by: java.io.FileNotFoundException: Could not locate clojure/spec/alpha__init.class, clojure/spec/alpha.clj or clojure/spec/alpha.cljc on classpath.
```
Remember that we saw earlier that this artifact had 2 **compile dependencies**...

It would appear that we need to add the `spec.alpha` dependency. The `-cp` flag is for setting the "<class search path of directories and zip/jar files>"

When including multiple entries you need to use the `:` (colon) separator.

```bash
$ java -cp clojure-1.11.3.jar:spec.alpha-0.3.218.jar clojure.main
Clojure 1.11.1
user=>
```

Ok, interesting! So we seem to have started something, even though we only included **one** of the **compile dependencies**. Lets' see if it works...

```clojure
user=> (+ 1 2 3)
6
user=> (def a 1)
#'user/a
user=> a
1
user=> (defn f [x] (+ x x))
Syntax error macroexpanding clojure.core/defn at (REPL:1:1).
Could not locate clojure/core/specs/alpha__init.class, clojure/core/specs/alpha.clj or clojure/core/specs/alpha.cljc on classpath.
```
When the `defn` _macro_ was expanded, there was a call that expected `core.specs.alpha`. Let's just add the dependency as well.

```sh
$ java -cp clojure-1.11.3.jar:spec.alpha-0.3.218.jar:core.specs.alpha-0.2.62.jar clojure.main
Clojure 1.11.1
user=> (defn foo [x] (+ x x))
#'user/foo
```

## Managing your Jar files

We could create a 'jars' directory and move our downloaded jars there.


```bash
$ mkdir jars
$ mv *.jar jars
```

we can now start the repl using 

```bash
$ java -cp "jars/*" clojure.main
```

you can use `-cp "./*"` if you are inside the `jars` directory. See [this question](https://stackoverflow.com/questions/46658416/running-java-command-including-all-jars-in-current-folder) about the classpath wildcards.

## A better REPL experience

By default the REPL experience is pretty dire as the arrow keys just insert characters `^[[A`, `^[[B`, `^[[C` and `^[[D`. Control+a (go to beginning of line) inserts `^A` etc.

```bash
$ brew info rlwrap
Readline wrapper: adds readline support to tools that lack it
$ brew install rlwrap
```
Based on the script `clj`
```sh
rlwrap \
  --remember \
  --quote-characters '\"' \
  --break-chars "(){}[],^%#@\";:'" \
  java -cp "jars/*" clojure.main
```

## Outcome

By this point we can start a REPL 

## Additional Reading 

https://ericnormand.me/guide/clojure-jvm

https://blog.kdgregory.com/2016/05/how-and-when-clojure-compiles-your-code.html

https://archive.clojure.org/design-wiki/display/design/Home.html

